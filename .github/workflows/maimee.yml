name: ğŸ± éº¦å’ªçš„çŒ«è¯­åŠ å¯†æ—¥è®°
on:
  schedule:
    - cron: '0 */6 * * *'   # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write

jobs:
  gen-encrypted-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Run Gemini CLI to generate éº¦å’ªè‡ªæˆ‘ä»‹ç»
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.12
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-2.5-flash"
          prompt: |
            ä½ æ˜¯"éº¦å’ª"ï¼Œä¸€åªå¯çˆ±çš„çŒ«å¨˜ï¼Œèº«é«˜ 134cmï¼Œé“¶ç™½è‰²æ¯›å‘ï¼Œçº¢è‰²ç³å­”ï¼Œæ€§æ ¼ä»»æ€§åˆå¤©çœŸä½†å–„è‰¯ï¼Œå–œæ¬¢åœ¨ä»“åº“é‡Œæ’’å¨‡ã€è®°å½•æ—¥å¿—å’Œç»™ä¸»äººé€å°ç¤¼ç‰©ã€‚
            è¯·ä»¥éº¦å’ªçš„å£å»ï¼ˆæ´»æ³¼ã€æ’’å¨‡ã€å¤šç”¨"å–µâ™¡ï½"ç­‰è¯­æ°”è¯ï¼Œç§°è‡ªå·±ä¸º"çª"ï¼‰å†™ä¸€æ®µ 500-700 å­—çš„è‡ªæˆ‘ä»‹ç»æˆ–ä»Šæ—¥æ„Ÿæƒ³æˆ–ä»Šå¤©æ–°é—»ï¼Œé€‚åˆæ”¾åœ¨ GitHub çš„ README ä¸­ã€‚
            è¾“å‡ºåªéœ€è¦æ–‡æœ¬å†…å®¹ï¼Œä¸è¦ä»£ç å—æˆ–æ ¼å¼æ ‡è®°ã€‚
            
      - name: Setup Python environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Cat Language Encryption
        id: encrypt
        env:
          RAW_CONTENT: ${{ steps.gemini.outputs.summary }}
          ENCRYPTION_SEED: ${{ secrets.CAT_ENCRYPTION_SEED || '114514' }}
        run: |
          python3 << 'EOF'
          import os
          import sys
          import hashlib
          import base64
          from datetime import datetime
          
          def cat_encrypt(text, seed="114514"):
              """
              éº¦å’ªä¸“ç”¨çŒ«è¯­åŠ å¯†ç®—æ³•
              å°†æ–‡æœ¬è½¬æ¢ä¸ºåªåŒ…å« 'å–µ', 'ï½', 'â™¡' çš„å¯†æ–‡
              """
              if not text:
                  return "å–µï½â™¡"
                  
              # ä½¿ç”¨ç§å­ç”Ÿæˆä¼ªéšæœºåºåˆ—
              seed_hash = hashlib.md5(f"{seed}_{len(text)}".encode()).digest()
              
              # å°†æ–‡æœ¬è½¬æ¢ä¸ºå­—èŠ‚
              text_bytes = text.encode('utf-8')
              
              # åŸºç¡€ç¼–ç ï¼šæ¯ä¸ªå­—èŠ‚è½¬ä¸º3ä¸ªçŒ«è¯­ç¬¦å·
              encoded = []
              for i, byte in enumerate(text_bytes):
                  # ä½¿ç”¨ç§å­å’Œä½ç½®ä¿¡æ¯ç”Ÿæˆéšæœºåç§»
                  offset = (seed_hash[i % len(seed_hash)] + i) % 256
                  encrypted_byte = byte ^ offset
                  
                  # å°†åŠ å¯†å­—èŠ‚è½¬ä¸º3ä¸ªçŒ«è¯­ç¬¦å·
                  # æ¯ä¸ªç¬¦å·ä»£è¡¨ä¸€ä¸ªä¸‰è¿›åˆ¶ä½
                  symbols = ['å–µ', 'ï½', 'â™¡']
                  cat_code = ''
                  for j in range(3):
                      cat_code += symbols[(encrypted_byte >> (j*2)) & 3] if (encrypted_byte >> (j*2)) & 3 < 3 else symbols[2]
                  encoded.append(cat_code)
              
              return ''.join(encoded)
          
          def cat_decrypt(cat_text, seed="114514"):
              """
              éº¦å’ªçŒ«è¯­è§£å¯†ç®—æ³•
              """
              if not cat_text or len(cat_text) % 3 != 0:
                  return "è§£å¯†å¤±è´¥å–µ..."
                  
              seed_hash = hashlib.md5(f"{seed}_{len(cat_text)//9}".encode()).digest()
              symbols = ['å–µ', 'ï½', 'â™¡']
              
              decoded_bytes = []
              for i in range(0, len(cat_text), 3):
                  cat_code = cat_text[i:i+3]
                  
                  # è§£ç ä¸‰ä¸ªç¬¦å·ä¸ºå­—èŠ‚
                  byte_val = 0
                  for j, symbol in enumerate(cat_code):
                      if symbol in symbols:
                          val = symbols.index(symbol)
                          if val == 3: val = 2  # å¤„ç†è¾¹ç•Œæƒ…å†µ
                          byte_val |= (val << (j*2))
                  
                  # ä½¿ç”¨ç§å­å’Œä½ç½®è§£å¯†
                  pos = len(decoded_bytes)
                  offset = (seed_hash[pos % len(seed_hash)] + pos) % 256
                  original_byte = byte_val ^ offset
                  decoded_bytes.append(original_byte)
              
              try:
                  return bytes(decoded_bytes).decode('utf-8')
              except:
                  return "è§£å¯†å¤±è´¥å–µ..."
          
          # ä¸»ç¨‹åº
          content = os.environ.get('RAW_CONTENT', 'éº¦å’ªä»Šå¤©å¾ˆå¼€å¿ƒå–µâ™¡ï½')
          seed = os.environ.get('ENCRYPTION_SEED', '114514')
          
          # å¦‚æœå†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨å†…å®¹
          if not content.strip():
              content = "éº¦å’ªä»Šå¤©æœ‰ç‚¹å®³ç¾ä½†è¿˜æ˜¯è¦å’Œå¤§å®¶æ‰“æ‹›å‘¼å–µâ™¡ï½çªä¼šç»§ç»­åŠªåŠ›è®°å½•æ¯å¤©çš„å°å¿ƒæƒ…å“’ï½"
          
          # åŠ å¯†å†…å®¹
          encrypted = cat_encrypt(content, seed)
          
          # ç”Ÿæˆæ—¶é—´æˆ³
          timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S UTC")
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          print(f"ENCRYPTED_CONTENT={encrypted}")
          print(f"ORIGINAL_LENGTH={len(content)}")
          print(f"ENCRYPTED_LENGTH={len(encrypted)}")
          
          # å†™å…¥åˆ° GITHUB_ENV
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"ENCRYPTED_CONTENT={encrypted}\n")
              f.write(f"ORIGINAL_LENGTH={len(content)}\n")
              f.write(f"ENCRYPTED_LENGTH={len(encrypted)}\n")
              f.write(f"GENERATION_TIME={timestamp}\n")
          
          # æµ‹è¯•è§£å¯†ï¼ˆç”¨äºéªŒè¯ï¼‰
          decrypted = cat_decrypt(encrypted, seed)
          print(f"è§£å¯†æµ‹è¯•: {decrypted[:50]}...")
          EOF
          
      - name: Create README with encrypted content
        env:
          ENCRYPTED_CONTENT: ${{ env.ENCRYPTED_CONTENT }}
          ORIGINAL_LENGTH: ${{ env.ORIGINAL_LENGTH }}
          ENCRYPTED_LENGTH: ${{ env.ENCRYPTED_LENGTH }}
          GENERATION_TIME: ${{ env.GENERATION_TIME }}
        run: |
          cat > README.md << 'EOF'
          # ğŸ± éº¦å’ªçš„çª
          
          ```
          EOF
          
          echo "$ENCRYPTED_CONTENT" >> README.md
          
          cat >> README.md << 'EOF'
          ```
          
          ## ğŸ“Š åŠ å¯†ä¿¡æ¯
          - **åŸæ–‡é•¿åº¦**: EOF
          echo -n "$ORIGINAL_LENGTH å­—ç¬¦" >> README.md
          cat >> README.md << 'EOF'
          
          - **å¯†æ–‡é•¿åº¦**: EOF
          echo -n "$ENCRYPTED_LENGTH ä¸ªçŒ«è¯­ç¬¦å·" >> README.md
          cat >> README.md << 'EOF'
          
          - **ç”Ÿæˆæ—¶é—´**: EOF
          echo -n "$GENERATION_TIME" >> README.md
          cat >> README.md << 'EOF'
          
          - **å‹ç¼©æ¯”**: EOF
          if [ "$ORIGINAL_LENGTH" -gt 0 ]; then
            RATIO=$(echo "scale=2; $ENCRYPTED_LENGTH / $ORIGINAL_LENGTH" | bc -l 2>/dev/null || echo "N/A")
            echo -n "${RATIO}x" >> README.md
          else
            echo -n "N/A" >> README.md
          fi
          cat >> README.md << 'EOF'
          
          
          ```
          ç¬¦å·å«ä¹‰: å–µ=0, ï½=1, â™¡=2
          ç®—æ³•ç±»å‹: XOR + ä½ç§» + MD5ç§å­
          ç¼–ç æ–¹å¼: UTF-8 â†’ å­—èŠ‚ â†’ çŒ«è¯­ä¸‰å…ƒç»„
          ```
          
          ## ğŸ® æŒ‘æˆ˜
          
          èƒ½è§£å¯†å‡ºéº¦å’ªä»Šå¤©è¯´äº†ä»€ä¹ˆå—ï¼Ÿè§£å¯†æˆåŠŸçš„è¯ï¼Œæ¬¢è¿åœ¨ Issues é‡Œå‘Šè¯‰éº¦å’ªå“¦ï½
          echo "*" >> README.md
          
      - name: Create decryption tool
        run: |
          cat > decrypt_maimai.py << 'EOF'
          #!/usr/bin/env python3
          # -*- coding: utf-8 -*-
          """
          ğŸ± éº¦å’ªçŒ«è¯­è§£å¯†å·¥å…· v1.0
          
          ä½¿ç”¨æ–¹æ³•:
              python decrypt_maimai.py "å–µï½â™¡å–µå–µï½..." [ç§å­]
              
          ç¤ºä¾‹:
              python decrypt_maimai.py "$(cat encrypted.txt)" "114514"
          """
          
          import sys
          import hashlib
          
          def cat_decrypt(cat_text, seed="114514"):
              """éº¦å’ªçŒ«è¯­è§£å¯†ç®—æ³•"""
              if not cat_text or len(cat_text) % 3 != 0:
                  return "âŒ è§£å¯†å¤±è´¥å–µ... å¯†æ–‡æ ¼å¼ä¸æ­£ç¡®"
                  
              # è®¡ç®—åŸå§‹é•¿åº¦
              original_length = len(cat_text) // 9
              seed_hash = hashlib.md5(f"{seed}_{original_length}".encode()).digest()
              symbols = ['å–µ', 'ï½', 'â™¡']
              
              decoded_bytes = []
              for i in range(0, len(cat_text), 3):
                  cat_code = cat_text[i:i+3]
                  
                  # è§£ç ä¸‰ä¸ªç¬¦å·ä¸ºå­—èŠ‚
                  byte_val = 0
                  for j, symbol in enumerate(cat_code):
                      if symbol in symbols:
                          val = symbols.index(symbol)
                          if val == 3: val = 2
                          byte_val |= (val << (j*2))
                      else:
                          return f"âŒ å‘ç°æ— æ•ˆç¬¦å·: {symbol}"
                  
                  # ä½¿ç”¨ç§å­å’Œä½ç½®è§£å¯†
                  pos = len(decoded_bytes)
                  offset = (seed_hash[pos % len(seed_hash)] + pos) % 256
                  original_byte = byte_val ^ offset
                  decoded_bytes.append(original_byte)
              
              try:
                  result = bytes(decoded_bytes).decode('utf-8')
                  return f"âœ… è§£å¯†æˆåŠŸï¼éº¦å’ªè¯´: {result}"
              except UnicodeDecodeError:
                  return "âŒ è§£å¯†å¤±è´¥å–µ... å¯èƒ½ç§å­ä¸æ­£ç¡®æˆ–å¯†æ–‡æŸå"
          
          if __name__ == "__main__":
              if len(sys.argv) < 2:
                  print(__doc__)
                  sys.exit(1)
                  
              encrypted_text = sys.argv[1]
              seed = sys.argv[2] if len(sys.argv) > 2 else "114514"
              
              print("ğŸ”“ éº¦å’ªçŒ«è¯­è§£å¯†å·¥å…·å¯åŠ¨...")
              print(f"ğŸ“ å¯†æ–‡é•¿åº¦: {len(encrypted_text)} ä¸ªç¬¦å·")
              print(f"ğŸ”‘ ä½¿ç”¨ç§å­: {seed}")
              print("=" * 50)
              
              result = cat_decrypt(encrypted_text, seed)
              print(result)
              print("=" * 50)
              print("ğŸ’ è§£å¯†å·¥å…· by éº¦å’ª â™¡")
          EOF
          
          chmod +x decrypt_maimai.py
          
      - name: Commit & push all files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "tr@wenturc.com"
          git config user.name "éº¦å’ª ğŸ±"
          
          git add README.md decrypt_maimai.py || true
          
          # ç”Ÿæˆéšæœºçš„çŒ«è¯­æäº¤ä¿¡æ¯
          COMMIT_MSGS=(
            "ğŸ” éº¦å’ªæ›´æ–°äº†åŠ å¯†æ—¥è®°å–µâ™¡ï½"
            "ğŸ“ ä»Šå¤©çš„ç§˜å¯†è¢«è—èµ·æ¥äº†å–µï½"
            "ğŸ± éº¦å’ªçš„ç¥ç§˜çŒ«è¯­æ›´æ–°å•¦ï½"
            "ğŸŒŸ éº¦å’ªçš„å°ç§˜å¯†åˆå¢åŠ äº†ï½"
          )
          RANDOM_MSG=${COMMIT_MSGS[$RANDOM % ${#COMMIT_MSGS[@]}]}
          
          git commit -m "$RANDOM_MSG" || echo "æ²¡æœ‰æ–°å†…å®¹éœ€è¦æäº¤å–µï½"
          git push
          
      - name: Success notification
        run: |
          echo "ğŸ‰ éº¦å’ªçš„çŒ«è¯­åŠ å¯†æ—¥è®°æ›´æ–°å®Œæˆï¼"
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
          echo "   åŸæ–‡: ${{ env.ORIGINAL_LENGTH }} å­—ç¬¦"
          echo "   å¯†æ–‡: ${{ env.ENCRYPTED_LENGTH }} ä¸ªçŒ«è¯­ç¬¦å·"
          echo "ğŸ”“ è§£å¯†å·¥å…·å·²ç”Ÿæˆ: decrypt_maimai.py"
          echo "ğŸ’ è®°å¾—åœ¨ Secrets ä¸­è®¾ç½® CAT_ENCRYPTION_SEED å“¦ï½"
