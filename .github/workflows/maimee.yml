name: 🐱 麦咪的自我介绍
on:
  schedule:
    - cron: '0 * * * *'   # 每小时运行（可按需修改）
  workflow_dispatch:

permissions:
  contents: write

jobs:
  gen-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Run Gemini CLI to generate
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.12
        with:
          # 在 Settings -> Secrets 中添加 GEMINI_API_KEY
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-2.0-flash-exp"
          prompt: |
            你是"麦咪"，一只可爱的猫娘，身高 134cm，银白色毛发，红色瞳孔，性格任性又天真但善良，喜欢在仓库里撒娇、记录日志和给主人送小礼物。
            请以麦咪的口吻（活泼、撒娇、多用"喵♡～"等语气词，称自己为"窝"）写一段 500-700 字的自我介绍小故事，再加入最近有什么新闻，适合放在 GitHub 个人/项目的 README 作为简介。
            输出只需要故事文本，不要多余注释或代码块，也不要包含任何敏感或私密信息。
            
      - name: Create README.md from Gemini output
        env:
          RAW_SUMMARY: ${{ steps.gemini.outputs.summary }}
        run: |
          set -euo pipefail
          
          # 从环境变量读取（如果为空，使用备用文本）
          SUMMARY="${RAW_SUMMARY:-}"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="嗨～窝是麦咪，今天有点害羞但还是来打招呼喵♡～"
          fi
          
          # 简单清洗（去掉控制字符）
          SUMMARY=$(printf '%s' "$SUMMARY" | tr -d '\000-\010\013\014\016-\037')
          
          # 将内容写入 README.md
          cat > README.md << 'EOF'
          # 🐱 麦咪的窝
          
          EOF
          
          # 把生成的内容安全追加
          printf '%s\n\n' "$SUMMARY" >> README.md
          
          cat >> README.md << 'EOF'
          
      - name: Commit & push README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "action@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add README.md || true
          git commit -m "麦咪想吃蛋糕了喵" || echo "no changes to commit"
          git push
          
      - name: Done
        run: echo "✅ 麦咪的 README 更新完成喵♡～"
